import{A as g,x as H,X as ee}from"./entry.819ce933.js";import{ad as V,af as Z,k as te,aj as x,a6 as C,ae as B,w as Q,U as j,V as X,W as Y,u as q,ak as O,T as A,aa as re,ab as ie}from"./constants.8e39bf94.js";import{A as ae,c as ne,C as $}from"./HLConst.18ce99b8.js";import{F as se}from"./FunnelServices.4c5adf48.js";import{f as G}from"./funnel_event_helper.3fa06503.js";const Se={base:{color:"#32325d",fontFamily:'"Helvetica Neue", Helvetica, sans-serif',fontSmoothing:"antialiased",fontSize:"16px","::placeholder":{color:"#aab7c4"}},invalid:{color:"#fa755a",iconColor:"#fa755a"}},ve=(e,t,i)=>{let s=[];return{updatedProducts:e.map(a=>{if(a._id===i._id){if(t>a.max)return a.qty=a.qty,s.push(`A maximum of ${a.max} units of ${a.name} only can be purchased`),a;if(t>a.price.availableQuantity&&a.price.trackInventory&&!a.price.allowOutOfStockPurchases)return a.qty=a.qty,s.push(`Only ${a.price.availableQuantity} units of ${a.name} are in stock`),a;a.qty=t}return a}),errorMessages:s}},he=e=>{var t,i,s;return((t=e==null?void 0:e.price)==null?void 0:t.availableQuantity)<=0&&((i=e==null?void 0:e.price)==null?void 0:i.trackInventory)&&!((s=e==null?void 0:e.price)!=null&&s.allowOutOfStockPurchases)},we=(e,t)=>t.find(i=>i._id===e.id),oe=async({contactId:e,domain:t,pageUrl:i,locationId:s,productPreviewList:l,isCouponApplied:a,couponCode:r,couponSessionId:n,store:m,subType:f,traceId:o="",reCaptchaToken:c,isEcommercePurchase:I,shippingRateId:S,toZip:w,toState:_,toCountry:v})=>{var d,E,T,k;try{const y=g("msgsndr_id").value,M=g("am_id").value,p=g("am_fingerprint").value,U=m.funnelName||"funnel";t||(t=window.location.hostname,i=window.location.pathname);const{funnelPageId:L,funnelId:F,stepId:W}=m,b={altId:s,altType:"location",shippingRateId:S,contactId:e,source:{type:m.pageType===O.FUNNEL?O.FUNNEL:O.WEBSITE,subType:f,id:F,name:U,meta:{stepId:W,pageId:L,domain:t,pageUrl:i,affiliateManager:{id:M,fingerprint:p}}},products:l.map(h=>({id:I?h.selectedPrice._id:h._id,qty:h.qty||h.quantity})),fingerprint:y,trackingId:x(),traceId:o,toZip:w,toState:_,toCountry:v};a&&(b.couponCode=r,b.couponSessionId=n),c&&(b.captchaToken=c);const N=await A.createOrder(b);if(!((d=N.order)==null?void 0:d._id))throw new Error("Something went wrong while creating order. Please try again later.");return N}catch(y){return console.error(y),{error:!0,message:(T=(E=y==null?void 0:y.response)==null?void 0:E._data)==null?void 0:T.message,status:(k=y==null?void 0:y.response)==null?void 0:k.status}}},le=async(e,t,i,s,l,a)=>{var h,z,J;const r=g("msgsndr_id").value,n=g("am_id").value,m=g("am_fingerprint").value,f=X(e.locationId),o=Y(e.locationId),c=j(),I=e.funnelName||"funnel";let{domain:S,page_url:w}=t.query;S||(S=window.location.hostname,w=window.location.pathname);const{funnelPageId:_,funnelId:v,stepId:d}=e,E={eventType:"optin",domainName:S,pageUrl:w,funnelId:v,pageId:_,stepId:d},{address:T,country:k,state:y,city:M,zipcode:p,fullName:U,phoneNumber:L,emailId:F,companyName:W}=i,b={addressLine1:T,country:k||s,state:y,city:M,zip:p};c.medium=re.OrderForm,c.mediumId=E.stepId;const N={lead:!0,eventData:c,source:I,pageId:_,funnelId:v,sessionId:f,funnelEventData:E,sessionFingerprint:o||null},P={locationId:e.locationId,name:U,phone:L,email:(F==null?void 0:F.toLowerCase())||"",companyName:W,address:b,attribution:N,timezone:ie(),amId:String(n),amFingerprint:m,orderFormType:"one_step_form_submission",captchaToken:l};a.enableStickyContact&&(P.attribution.fingerprint=r,P.attribution.funnelEventData.fingerprint=r),a.enableForceCreate&&(P.attribution.forceCreate=!0),a.enableEmailValidation&&(P.attribution.session_d=Number(a.enableEmailValidation)||0);try{const u=await se.createContact(P);if(!u)throw new Error("Something went wrong. Please try again later.");if(r!==u.fingerprint){e.fingerprint=r;const R=g("msgsndr_id",{path:"/",maxAge:31536e3});R.value=u.fingerprint}x();const K=B(u);Q("_ud",K),H(()=>{G("track","SubmitApplication")});let D=u.sessionFingerprint;return c&&(V({sessionId:u.sessionId||null,locationId:e.locationId}),D&&Z(e.locationId,D)),u}catch(u){return console.error(u),{error:!0,message:(z=(h=u==null?void 0:u.response)==null?void 0:h._data)==null?void 0:z.message,status:(J=u==null?void 0:u.response)==null?void 0:J.status}}},_e=async(e,t,i,s,l,a,r,n,m,f,o,c,I,S,w,_)=>{var v;if((!r||!r.id)&&(r=await le(e,t,i,s,l,a),l=void 0),r!=null&&r.error){let d={};return(r==null?void 0:r.status)===429?(d={error:!0,processingPayment:!1,showRecaptcha:!0},d):(d={error:!0,processingPayment:!1,cardErrorMsg:r.message||"We're sorry, but something went wrong. Please try again"},d)}if((r.id&&!n||!((v=n==null?void 0:n.order)!=null&&v._id))&&(n=await oe({contactId:r==null?void 0:r.id,domain:e.domain,pageUrl:e.pageUrl,locationId:e.locationId,productPreviewList:f,isCouponApplied:m,couponCode:c,couponSessionId:o,store:e,subType:S,traceId:r==null?void 0:r.traceId,reCaptchaToken:l,isEcommercePurchase:I,shippingRateId:w,toZip:i.zipcode,toState:_,toCountry:i.country}),l=void 0),n!=null&&n.error){let d={};return n.status===429?(d={error:!0,processingPayment:!1,showRecaptcha:!0,contactResponse:r},d):(d={error:!0,processingPayment:!1,contactResponse:r,cardErrorMsg:n.message||"We're sorry, but something went wrong. Please try again"},d)}return(n==null?void 0:n.success)===!1?{error:!0,cardErrorMsg:n==null?void 0:n.message,processingPayment:!1}:(sessionStorage.setItem("orderResponse",JSON.stringify(n)),S!=C.TWO_STEP_ORDER_FORM&&sessionStorage.setItem("contactResponse",JSON.stringify(r)),sessionStorage.setItem("orderResponse",JSON.stringify(n)),S!=C.TWO_STEP_ORDER_FORM&&sessionStorage.setItem("contactResponse",JSON.stringify(r)),sessionStorage.setItem("orderResponse",JSON.stringify(n)),S!=C.TWO_STEP_ORDER_FORM&&sessionStorage.setItem("contactResponse",JSON.stringify(r)),{contactResponse:r,orderResponse:n,reCaptchaToken:l})},ue=(e,t,i,s)=>{var a;if(x()!=i.verifiedTrackingId){const r=g("tr",{path:"/",maxAge:900});r.value=i.verifiedTrackingId}if(s!==C.TWO_STEP_ORDER_FORM){if(e.fingerprint!==t){const n=g("msgsndr_id",{path:"/",maxAge:31536e3});n.value=e.fingerprint}const r=B(e);Q("_ud",r)}if((a=e==null?void 0:e.attribution_source)!=null&&a.fbEventId){let r=e.attribution_source.fbEventId;H(()=>{G("track","OrderFormPurchase",r)})}else console.warn("Facebook event Id missing from attribution!")},be=async(e,t,i,s,l)=>{let a=!1,r="";if(t.message&&!t.success)throw new Error(t.message);i===ae&&(t!=null&&t.pendingConfirmation)&&(a=!0,r="Order placed successfully! However your transaction is pending for review. Please contact the business owner");const n=g("msgsndr_id").value;await ue(e,n,t,l);const m=g("provider");m.value=i===ne?"pp":i===$?$:"cc",await de({sessionId:e.sessionId,sessionFingerprint:t.sessionFingerprint},s);const f=sessionStorage.getItem("redirect");if(ge(s),f){sessionStorage.removeItem("redirect"),window.location.href=f;return}return{paymentResponseData:t,authorizeOrderPendingConfirmation:a,authorizeOrderAlertMsg:r}},de=(e,t)=>{e&&e.sessionId&&(V({sessionId:e.sessionId||null,locationId:t}),e.sessionFingerprint&&Z(t,e.sessionFingerprint))},Pe=(e,t,i)=>{var s;return{facilitatorAccessToken:e.facilitatorAccessToken,orderId:(s=t==null?void 0:t.order)==null?void 0:s._id,paypalOrderId:e.orderID,altId:i,altType:"location",attribution:{eventData:j(),sessionId:X(i),sessionFingerprint:Y(i)}}},Oe=e=>{var i;(!(e.keyCode>=48&&e.keyCode<=57||e.keyCode>=96&&e.keyCode<=105)||!/^\d{0,2}$/.test((i=e.target)==null?void 0:i.value))&&e.keyCode!==8&&e.preventDefault()},ge=e=>{const t=te();return sessionStorage.setItem(`couponSessionId_${e}`,t),t},Ee=async(e,t,i="",s,l,a)=>{var r,n,m,f;try{const o=q(),c={altId:o.value.locationId,altType:"location",couponCode:i,source:{type:o.value.pageType===O.FUNNEL?O.FUNNEL:O.WEBSITE,subType:t,id:o.value.funnelId,name:o.value.funnelName,meta:{stepId:o.value.stepId,pageId:o.value.funnelPageId,domain:o.value.domain,pageUrl:o.value.pageUrl,affiliateManager:{id:g("am_id").value,fingerprint:g("msgsndr_id").value}}},products:e,toCountry:s,toState:l,toZip:a},I=await A.getAmountSummary(c);return{total:I.summary.total,subtotal:I.summary.subtotal,taxSummary:I.summary.taxSummary,subtotalWithDiscount:I.summary.subtotalWithDiscount}}catch(o){return console.error(o),{error:!0,message:((n=(r=o==null?void 0:o.response)==null?void 0:r._data)==null?void 0:n.message)||"Something went wrong while fetching order total. Please try again later",status:(f=(m=o==null?void 0:o.response)==null?void 0:m._data)==null?void 0:f.status}}},Fe=async(e,t)=>{const i=await A.getLastPaymentMethodForTheCustomer({altId:e,altType:"location",contactId:t});return i==null?void 0:i.paymentMethod},Te=async()=>{const e=q();try{const t=await A.getStatesInformation();if(t&&t.error)throw ee(t.error);e.value.countryList=(t==null?void 0:t.data)??[]}catch(t){console.error("Failed to fetch country list",t)}},ke=e=>q().value.countryList.find(i=>i.code===e);export{ke as a,Ee as b,oe as c,ge as d,we as e,Fe as f,Te as g,be as h,he as i,Pe as j,ve as k,_e as l,Oe as m,Se as s};
